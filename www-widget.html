<!DOCTYPE html>
<html lang="en-ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCES Widget</title>
    <script src="./resources/js/jquery-2.2.4.min.js"></script>
</head>
<style>
    #sces-widget {
        font-family: sans-serif;background: #f9f9f9;border: 1px solid #ccc;padding: 1em;border-radius: 8px;max-width: 800px;
    }
    #sces-widget select {
        padding: 0.5em;font-size: 1em;
    }
    #sces-result h3 {
        margin-top: 1em;color: #CC0000;
    }
    #sces-result a {
        color: #0077cc;text-decoration: none;
    }
    #sces-result a:hover {
        text-decoration: underline;
    }
    </style>
<body>
<div id="sces-widget" class="sces-widget"></div>

<script>
const CONFIG = {
    urls: {
        deptRequirements: './resources/data/SCES_Dept_Requirements.json',
        scesScope: './resources/data/SCES_Scope.json',
        explanations: './resources/data/SCES_Explinations.json'
    },
};

(async function loadSCESWidget() {
    const container = $('#sces-widget');
    container.html('<p>Loading data...</p>');

    try {
        const [deptRes, scopeRes, explRes] = await Promise.all([
            fetch(CONFIG.urls.deptRequirements),
            fetch(CONFIG.urls.scesScope),
            fetch(CONFIG.urls.explanations)
        ]);

        const deptData = await deptRes.json();
        const scopeData = await scopeRes.json();
        const explanationData = await explRes.json();

        // Sort by Qbank Dept
        deptData.sort((a, b) => a['Qbank Dept'].localeCompare(b['Qbank Dept']));

        // Build dropdown
        const selectHTML = `
            <label for="programSelect"><strong>Select a program:</strong></label>
            <select id="programSelect" class="form-control">
                <option value="">-- Choose a program --</option>
                ${deptData.map(d => `<option value="${d['Program-Name']}">${d['Qbank Dept']} - ${d['Program-Name']}</option>`).join('')}
            </select>
            <div id="sces-result" style="margin-top:1em;"></div>
        `;
        container.html(selectHTML);

        // Handle selection
        $('#programSelect').on('change', function() {
            const selectedProgram = $(this).val();
            const programInfo = deptData.find(d => d['Program-Name'] === selectedProgram);
            const resultDiv = $('#sces-result');

            if (programInfo) {
                // Scope text
                const scopeText = scopeData[programInfo.Scope] || "Unknown";

                // Contact email(s)
                const contactHTML = programInfo.Contact && programInfo.Contact !== "null"
                    ? programInfo.Contact.split(';').map(u => 
                        `<a href="mailto:${u}@brocku.ca">${u}@brocku.ca</a>`).join(', ')
                    : 'Unknown';

                // Filter 'Yes' values
                const yesFields = Object.entries(programInfo)
                    .filter(([key, value]) => value === "Yes")
                    .map(([key]) => key.replace(/-/g, ' ')); // Clean up key names if needed

                // Build result display
                let html = `
                    <h3>${programInfo['Qbank Dept']} - ${programInfo['Program-Name']}</h3>
                    <p><strong>Online Survey Participation:</strong> ${scopeText}</p>
                    <p><strong>CPI's Contact:</strong> ${contactHTML}</p>
                `;

                // Handle "Yes" values separately
                if (yesFields.length) {
                    html += `<p><strong>Additional Notes:</strong></p><ul>`;
                    yesFields.forEach(field => {
                        const desc = explanationData[field] || `Flagged: ${field}`;
                        html += `<li>${desc}</li>`;
                    });
                    html += `</ul>`;
                }

                // Handle exclusions separately
                if (programInfo.exclusions && programInfo.exclusions.length) {
                    html += `<p><strong>Exclusions:</strong></p><ul>`;
                    programInfo.exclusions.forEach(exclusion => {
                        html += `<li>${exclusion}</li>`;
                    });
                    html += `</ul>`;
                }

                resultDiv.html(html);

            } else {
                resultDiv.html('');
            }
        });

    } catch (error) {
        container.html('<p>Error loading data.</p>');
        console.error('SCES Widget Error:', error);
    }
})();
</script>

</body>
</html>
